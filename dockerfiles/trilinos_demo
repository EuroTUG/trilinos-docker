########
# base #
########
FROM centos:latest AS base

RUN sed -i 's/mirrorlist/#mirrorlist/g' /etc/yum.repos.d/CentOS-*
RUN sed -i 's|#baseurl=http://mirror.centos.org|baseurl=http://vault.centos.org|g' /etc/yum.repos.d/CentOS-*

RUN yum -y update
RUN yum -y install less wget emacs make m4 git gcc gcc-gfortran gcc-c++ blas lapack mpich mpich-devel boost boost-devel openssl-devel

ENV PATH=/usr/lib64/mpich/bin/:$PATH

###############
# cmake       #
###############
FROM base AS cmake

# Cmake
RUN CMAKE_VERSION=3.27.0-rc3 && \
    CMAKE_URL=https://github.com/Kitware/CMake/releases/download/v${CMAKE_VERSION} && \
    CMAKE_SCRIPT=cmake-${CMAKE_VERSION}-linux-x86_64.sh && \
    wget --quiet ${CMAKE_URL}/${CMAKE_SCRIPT} && \
    mkdir -p /opt/cmake && \
    sh ${CMAKE_SCRIPT} --skip-license --prefix=/opt/cmake && \
    rm cmake*
ENV PATH=/opt/cmake/bin:$PATH

###############
# suitesparse #
###############
FROM cmake AS suitesparse

# Suitesparse
WORKDIR /opt/suitesparse/
RUN wget -nv https://github.com/DrTimothyAldenDavis/SuiteSparse/archive/refs/tags/v5.4.0.tar.gz
RUN tar xfz /opt/suitesparse/v5.4.0.tar.gz
RUN mv /opt/suitesparse/SuiteSparse-5.4.0/ /opt/suitesparse/source
RUN rm /opt/suitesparse/v5.4.0.tar.gz
WORKDIR /opt/suitesparse/source
RUN make BLAS=/usr/lib64/libblas.so.3 LAPACK=/usr/lib64/liblapack.so.3 && make install BLAS=/usr/lib64/libblas.so.3 LAPACK=/usr/lib64/liblapack.so.3 INSTALL=/usr/local

############
# trilinos #
############
FROM suitesparse AS trilinos

ARG TRILINOS_CONFIGFILE=do-configure-trilinos.sh
ARG TRILINOS_VERSION=14-2-0

WORKDIR /opt/trilinos
COPY $TRILINOS_CONFIGFILE /opt/trilinos/do-configure-trilinos.sh
RUN wget -nv https://github.com/trilinos/Trilinos/archive/refs/tags/trilinos-release-$TRILINOS_VERSION.tar.gz && \
    mkdir source && \
    tar xfz /opt/trilinos/trilinos-release-$TRILINOS_VERSION.tar.gz -C /opt/trilinos/source --strip-components=1 && \
    rm -f /opt/trilinos/trilinos-release-$TRILINOS_VERSION.tar.gz && \
    mkdir build && pushd build && \
    ../do-configure-trilinos.sh && popd && \
    rm do-configure-trilinos.sh && \
    cmake --build build --parallel 4 && cmake --install build --prefix . && \
    rm -rf build source

# kokkos
RUN git clone --depth 1 --branch 4.0.01 https://github.com/kokkos/kokkos.git && cmake -S kokkos -B kokkos/build -DKokkos_ENABLE_OPENMP=ON && cmake --build kokkos/build/ --parallel 4 && cmake --install kokkos/build/ --prefix /opt/kokkos && rm -rf kokkos/
RUN git clone --depth 1 https://github.com/kokkos/kokkos-tutorials.git /opt/kokkos-tutorials

ENV CMAKE_PREFIX_PATH=/opt/trilinos/install:$CMAKE_PREFIX_PATH 

#################
# trilinos_demo #
#################
FROM trilinos AS trilinos_demo

# Trilinos demo
WORKDIR /opt/trilinos_demo
